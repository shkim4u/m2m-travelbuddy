version: 0.2

env:
  shell: bash
  git-credential-helper: yes
  variables:
    AWS_REGION: "ap-northeast-2"

phases:
  install:
    commands:
      - env
      - aws eks update-kubeconfig --name $CLUSTER_NAME
      - |
        # Install ArgoCD CLI.
        curl --silent --location -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/download/v2.4.7/argocd-linux-amd64
        chmod +x /usr/local/bin/argocd
        argocd version --client
  pre_build:
    commands:
      - echo "AWSCLI version..."
      - aws --version
      # [2023-12-24] KSH: GitOps를 위한 Helm Chart 파일에 업데이트하는 부분은 "deploy" 단계로 이동
      - export CERTIFICATE_ARN=`aws acm list-certificates --query "CertificateSummaryList[?DomainName=='www.mydemo.co.kr'].CertificateArn" --output text`
      - echo "## CERTIFICATE_ARN-> ${CERTIFICATE_ARN}"
      # [2023-12-24] KSH: Access to EKS cluster.
      - export AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output=text) && echo $AWS_ACCOUNT_ID
      - export CREDENTIALS=$(aws sts assume-role --role-arn $ASSUME_ROLE_ARN --role-session-name codebuild-deploy-eks-role) && echo $CREDENTIALS
      - export AWS_ACCESS_KEY_ID=$(echo "${CREDENTIALS}" | jq -r '.Credentials.AccessKeyId')
      - export AWS_SECRET_ACCESS_KEY=$(echo "${CREDENTIALS}" | jq -r '.Credentials.SecretAccessKey')
      - export AWS_SESSION_TOKEN=$(echo "${CREDENTIALS}" | jq -r '.Credentials.SessionToken')
      - export AWS_EXPIRATION=$(echo "${CREDENTIALS}" | jq -r '.Credentials.Expiration')
      - ls -altr
      - pwd
      - env
  build:
    commands:
      - |
        echo "Getting image tag from image_tag.txt file."
        export IMAGE_TAG=`cat image_tag.txt` && echo $IMAGE_TAG
      - |
        echo "### Updating image tag in Helm repo of ArgoCD Application ###"
        echo "Cloning ${APPLICATION_CONFIGURATION_REPO_URL}..."
        git clone ${APPLICATION_CONFIGURATION_REPO_URL} application-configuration
        cd application-configuration
        ls -al
        cat values-template.yaml | envsubst > ./values.yaml
        cat ./values.yaml
        git status
        git config user.email "anyone@example.com"
        git config user.name "WebGoat Developer"
        git add .
        git commit -m "Updated image tag to $IMAGE_TAG"
        git log --oneline
        git remote -v
        git push -u origin main
      - |
        # Get ArgoCD Server URL.
        export ARGOCD_SERVER=`kubectl get ingress/argocd-server -n argocd -o json | jq --raw-output '.status.loadBalancer.ingress[0].hostname'`
        echo "ARGOCD_SERVER: ${ARGOCD_SERVER}"
      - |
        # Acquire ArgoCD admin password from AWS Secrets Manager.
        export ARGOCD_ADMIN_PASSWORD=`aws secretsmanager get-secret-value --secret-id $ARGOCD_ADMIN_PASSWORD_SECRET_ID --query SecretString --output text`
      - |
        # Login to ArgoCD Server.
        argocd login ${ARGOCD_SERVER} --username admin --password ${ARGOCD_ADMIN_PASSWORD} --insecure
      - |
        # Sync ArgoCD Application.
        argocd app sync ${ARGOCD_APPLICATION_NAME} --insecure
  post_build:
    commands:
      - echo "post_build"
